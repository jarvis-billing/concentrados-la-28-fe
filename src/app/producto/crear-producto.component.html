<div class="container mb-5">
    <form [formGroup]="productoForm" (ngSubmit)="submit()" class="producto-form">
        <h1 class="text-center mt-4 mb-5 text-primary">{{ isEditMode ? 'Editar Producto' : 'Crear Producto' }}</h1>
        <hr />
        <div class="text-start">
            <button type="submit" class="btn btn-primary" [disabled]="productoForm.invalid">
                <i class="bi bi-save"></i>
                {{ isEditMode ? 'Guardar cambios' : 'Crear producto' }}
            </button>
            <button type="button" class="btn btn-outline-secondary ms-2" (click)="cancelar()">
                <i class="bi bi-x-circle"></i>
                Cancelar
            </button>
        </div>
        <div class="row" style="gap: 32px;">
            <div class="col-4">
                <!-- Columna izquierda: Datos básicos -->
                <div class="col-md-5 p-4" style="background: #f8f9fa; border-radius: 12px; min-width: 420px;">
                    <div class="row">
                        <h3>Datos Básicos</h3>
                        <div class="col-12 mb-4">
                            <label>Descripción</label>
                            <input formControlName="description" class="form-control" />
                            <small
                                *ngIf="productoForm.get('description')?.invalid && productoForm.get('description')?.touched">
                                Campo requerido (máx 100 caracteres)
                            </small>
                        </div>
                        <div class="col-6 mb-4">
                            <label>Tipo de venta</label>
                            <select formControlName="saleType" class="form-control" (change)="onSaleTypeChange($event)" >
                                <option *ngFor="let st of saleTypes" [value]="st">{{ saleTypeLabels[st] }}</option>
                            </select>
                        </div>
                        <div class="col-6 mb-4">
                            <label>Código de producto</label>
                            <input formControlName="productCode" class="form-control" />
                        </div>
                        <!-- Categoría -->
                        <div class="mb-4">
                            <label>Categoría</label>
                            <div class="input-group">
                                <select formControlName="category" class="form-control">
                                    <option *ngFor="let category of categoriesList" [value]="category">
                                        {{ category }}
                                    </option>
                                </select>
                                <input type="text" class="form-control" placeholder="Nueva categoría" #newCategoryInput
                                    (keydown.enter)="addCategory(newCategoryInput.value); productoForm.get('category')?.setValue(newCategoryInput.value); newCategoryInput.value='';">
                                <button type="button" class="btn btn-outline-secondary"
                                    (click)="addCategory(newCategoryInput.value); productoForm.get('category')?.setValue(newCategoryInput.value); newCategoryInput.value='';">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Marca -->
                        <div class="mb-4">
                            <label>Marca</label>
                            <div class="input-group">
                                <select formControlName="brand" class="form-control">
                                    <option *ngFor="let brand of brandsList" [value]="brand">
                                        {{ brand }}
                                    </option>
                                </select>
                                <input type="text" class="form-control" placeholder="Nueva marca" #newBrandInput
                                    (keydown.enter)="addBrand(newBrandInput.value); productoForm.get('brand')?.setValue(newBrandInput.value); newBrandInput.value='';">
                                <button type="button" class="btn btn-outline-secondary"
                                    (click)="addBrand(newBrandInput.value); productoForm.get('brand')?.setValue(newBrandInput.value); newBrandInput.value='';">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                        </div>

                        <fieldset class="mb-4 p-3" style="border:1px solid #e0e0e0; border-radius:8px;">
                            <legend class="w-auto px-2" style="font-size:1rem;">Stock</legend>
                            <hr />
                            <div class="row">
                                <div class="col-6 mb-3" formGroupName="stock">
                                    <label>Cantidad</label>
                                    <input type="number" formControlName="quantity" min="0" class="form-control" />
                                </div>
                                <div class="col-6 mb-3" formGroupName="stock">
                                    <label>Unidad de medida</label>
                                    <select formControlName="unitMeasure" class="form-control">
                                        <option *ngFor="let um of getAllowedUnitMeasures()" [value]="um">{{ unitMeasureLabels[um] }}</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Badge informativo con el stock legible del backend -->
                            <div *ngIf="isEditMode" class="mt-1">
                                <span *ngIf="loadedDisplayStock?.label; else baseStockForm"
                                      class="badge bg-secondary"
                                      [attr.title]="loadedDisplayStock?.packSize ? ('Tamaño pack: ' + loadedDisplayStock?.packSize + ' ' + loadedDisplayStock?.unit) : null">
                                    Stock actual: {{ loadedDisplayStock?.label }}
                                </span>
                                <ng-template #baseStockForm>
                                    <span class="badge bg-secondary">Stock actual: {{ productoForm.get('stock.quantity')?.value }} {{ productoForm.get('stock.unitMeasure')?.value }}</span>
                                </ng-template>
                            </div>
                        </fieldset>
                        <div class="col-6 mb-4">
                            <label>IVA (%)</label>
                            <input type="number" formControlName="vatValue" min="0" class="form-control" />
                        </div>
                        <div class="col-6 mb-4">
                            <label>Tipo de IVA</label>
                            <select formControlName="vatType" class="form-control">
                                <option [value]="null">Sin IVA</option>
                                <option *ngFor="let vt of vatTypes" [value]="vt">{{ vt }}</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="row mb-2">
                    <h3>Presentaciones</h3>
                    <button type="button" class="btn btn-secondary mb-3 mt-2" (click)="addPresentation()">
                        <i class="bi bi-plus-circle"></i>
                        Agregar presentación
                    </button>
                </div>
                <div formArrayName="presentations" class="presentation-item"
                    style="max-height: 600px; min-height: 350px; overflow-y: auto; overflow-x: auto; padding: 6px;">
                    <div class="row g-4">
                        <div *ngFor="let pres of presentations.controls; let i = index" [formGroupName]="i"
                            class="col-12 col-md-6">
                            <div class="card shadow-sm mb-4" style="min-width: 320px; border-radius: 12px;">
                                <div class="card-body">
                                    <!-- ...dentro de la card-body de cada presentación... -->
                                    <div class="row">
                                        <!-- Primera fila: Barcode + botón -->
                                        <div class="col-12 mb-3 d-flex align-items-end">
                                            <div style="flex: 1;">
                                                <label>Barcode</label>
                                                <input formControlName="barcode" class="form-control" />
                                            </div>
                                            <button type="button" class="btn btn-outline-secondary ms-2 mb-2"
                                                (click)="generateBarcode(i)">
                                                <i class="bi bi-upc-scan"></i>
                                                Generar
                                            </button>
                                        </div>
                                        <!-- Segunda fila: Etiqueta -->
                                        <div class="col-12 mb-3">
                                            <label>Etiqueta</label>
                                            <input formControlName="label" class="form-control" />
                                        </div>
                                        <!-- Resto de los campos -->
                                        <div class="col-6 mb-3">
                                            <label>Precio venta</label>
                                            <input type="text" formControlName="salePrice" min="0"
                                                class="form-control text-right" appCurrencyFormat />
                                        </div>
                                        <div class="col-6 mb-3">
                                            <label>Precio costo</label>
                                            <input type="text" formControlName="costPrice" min="0"
                                                class="form-control" appCurrencyFormat />
                                        </div>
                                        <div class="col-6 mb-3">
                                            <label>Unidad medida</label>
                                            <select formControlName="unitMeasure" class="form-control">
                                                <option *ngFor="let um of getAllowedUnitMeasures()" [value]="um">{{ unitMeasureLabels[um] }}</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Modo de venta aplicable a peso, volumen y longitud -->
                                        <div *ngIf="productoForm.get('saleType')?.value === 'WEIGHT' || productoForm.get('saleType')?.value === 'VOLUME' || productoForm.get('saleType')?.value === 'LONGITUDE'" class="col-12">
                                            <div class="row g-3 align-items-end">
                                                <!-- Título/Distintivo del modo seleccionado -->
                                                <div class="col-12">
                                                    <h6 class="mb-2">
                                                        <span *ngIf="presentations.at(i).get('saleMode')?.value === 'BULK'" class="badge bg-warning text-dark">Granel</span>
                                                        <span *ngIf="presentations.at(i).get('saleMode')?.value === 'FIXED_FULL'" class="badge bg-success">Bulto Completo ({{ presentations.at(i).get('fixedAmount')?.value || '-' }} {{ presentations.at(i).get('unitMeasure')?.value || '-' }})</span>
                                                        <span *ngIf="presentations.at(i).get('saleMode')?.value === 'FIXED_HALF'" class="badge bg-info">Medio Bulto ({{ presentations.at(i).get('fixedAmount')?.value || '-' }} {{ presentations.at(i).get('unitMeasure')?.value || '-' }})</span>
                                                    </h6>
                                                </div>

                                                <div class="col-12 d-flex align-items-center flex-wrap gap-3">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <label class="form-label mb-1 m-0">Modo de venta</label>
                                                        <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true"
                                                           title="<div class='text-start m-0 p-0'>
                                                             <div>• Granel: ingresa total $ → calcula cantidad</div>
                                                             <div>• Bulto Completo: tamaño completo del bulto</div>
                                                             <div>• Medio Bulto: mitad del tamaño del bulto (solo peso)</div>
                                                           </div>"></i>
                                                    </div>
                                                    <div class="d-flex flex-wrap gap-3">
                                                        <div class="form-check form-check-inline" *ngIf="isModeAvailable('BULK', i)">
                                                            <input class="form-check-input" type="radio" [value]="'BULK'" formControlName="saleMode" id="modeBulk_{{i}}">
                                                            <label class="form-check-label" for="modeBulk_{{i}}">Granel</label>
                                                        </div>
                                                        <div class="form-check form-check-inline" *ngIf="isModeAvailable('FIXED_FULL', i)">
                                                            <input class="form-check-input" type="radio" [value]="'FIXED_FULL'" formControlName="saleMode" id="modeFull_{{i}}">
                                                            <label class="form-check-label" for="modeFull_{{i}}">Bulto Completo</label>
                                                        </div>
                                                        <div class="form-check form-check-inline" *ngIf="productoForm.get('saleType')?.value === 'WEIGHT' && isModeAvailable('FIXED_HALF', i)">
                                                            <input class="form-check-input" type="radio" [value]="'FIXED_HALF'" formControlName="saleMode" id="modeHalf_{{i}}">
                                                            <label class="form-check-label" for="modeHalf_{{i}}">Medio Bulto</label>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Tamaño y cantidad fija resultante -->
                                                <div class="col-12 col-md-4" *ngIf="presentations.at(i).get('saleMode')?.value === 'FIXED_FULL' || presentations.at(i).get('saleMode')?.value === 'FIXED_HALF'">
                                                    <label class="form-label">Tamaño del bulto ({{ unitMeasureLabels[presentations.at(i).get('unitMeasure')?.value] || '-' }})</label>
                                                    <input type="number" class="form-control" formControlName="packSize" min="0.01" step="0.01">
                                                </div>
                                                <div class="col-12 col-md-4" *ngIf="presentations.at(i).get('saleMode')?.value === 'FIXED_FULL' || presentations.at(i).get('saleMode')?.value === 'FIXED_HALF'">
                                                    <label class="form-label">Cantidad fija resultante</label>
                                                    <input type="number" class="form-control" formControlName="fixedAmount" readonly>
                                                </div>
                                                
                                            </div>
                                        </div>
                                        <div class="col-12 text-end">
                                            <button type="button" class="btn btn-danger btn-sm mt-2"
                                                (click)="removePresentation(i)">
                                                <i class="bi bi-trash"></i>
                                                Eliminar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>