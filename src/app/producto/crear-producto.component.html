<div class="container mb-5">
    <form [formGroup]="productoForm" (ngSubmit)="submit()" class="producto-form">
        <h1 class="text-center mt-4 mb-5 text-primary">{{ isEditMode ? 'Editar Producto' : 'Crear Producto' }}</h1>
        <hr />
        <div class="text-start">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i>
                {{ isEditMode ? 'Guardar cambios' : 'Crear producto' }}
            </button>
            <button type="button" class="btn btn-outline-secondary ms-2" (click)="cancelar()">
                <i class="bi bi-x-circle"></i>
                Cancelar
            </button>
        </div>
        <div class="row" style="gap: 32px;">
            <div class="col-4">
                <!-- Columna izquierda: Datos básicos -->
                <div class="col-md-5 p-4" style="background: #f8f9fa; border-radius: 12px; min-width: 420px;">
                    <div class="row">
                        <h3>Datos Básicos</h3>
                        <div class="col-12 mb-4">
                            <label>Descripción</label>
                            <input formControlName="description" class="form-control" />
                            <small
                                *ngIf="productoForm.get('description')?.invalid && productoForm.get('description')?.touched">
                                Campo requerido (máx 100 caracteres)
                            </small>
                        </div>
                        <div class="col-6 mb-4">
                            <label>Tipo de venta</label>
                            <select formControlName="saleType" class="form-control" (change)="onSaleTypeChange($event)" >
                                <option *ngFor="let st of saleTypes" [value]="st">{{ saleTypeLabels[st] }}</option>
                            </select>
                        </div>
                        <div class="col-6 mb-4">
                            <label>Código de producto</label>
                            <input formControlName="productCode" class="form-control" />
                        </div>
                        <!-- Categoría -->
                        <div class="mb-4">
                            <label>Categoría</label>
                            <div class="input-group">
                                <select formControlName="category" class="form-control">
                                    <option *ngFor="let category of categories$ | async" [value]="category">
                                        {{ category }}
                                    </option>
                                </select>
                                <input type="text" class="form-control" placeholder="Nueva categoría" #newCategoryInput
                                    (keydown.enter)="addCategory(newCategoryInput.value); productoForm.get('category')?.setValue(newCategoryInput.value); newCategoryInput.value='';">
                                <button type="button" class="btn btn-outline-secondary"
                                    (click)="addCategory(newCategoryInput.value); productoForm.get('category')?.setValue(newCategoryInput.value); newCategoryInput.value='';">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Marca -->
                        <div class="mb-4">
                            <label>Marca</label>
                            <div class="input-group">
                                <select formControlName="brand" class="form-control">
                                    <option *ngFor="let brand of brands$ | async" [value]="brand">
                                        {{ brand }}
                                    </option>
                                </select>
                                <input type="text" class="form-control" placeholder="Nueva marca" #newBrandInput
                                    (keydown.enter)="addBrand(newBrandInput.value); productoForm.get('brand')?.setValue(newBrandInput.value); newBrandInput.value='';">
                                <button type="button" class="btn btn-outline-secondary"
                                    (click)="addBrand(newBrandInput.value); productoForm.get('brand')?.setValue(newBrandInput.value); newBrandInput.value='';">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                        </div>

                        <fieldset class="mb-4 p-3" style="border:1px solid #e0e0e0; border-radius:8px;">
                            <legend class="w-auto px-2" style="font-size:1rem;">Stock</legend>
                            <hr />
                            <div class="row">
                                <div class="col-6 mb-3" formGroupName="stock">
                                    <label>Cantidad</label>
                                    <input type="number" formControlName="quantity" min="0" class="form-control" />
                                </div>
                                <div class="col-6 mb-3" formGroupName="stock">
                                    <label>Unidad de medida</label>
                                    <select formControlName="unitMeasure" class="form-control">
                                        <option *ngFor="let um of unitMeasures" [value]="um">{{ unitMeasureLabels[um] }}
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </fieldset>
                        <div class="col-6 mb-4">
                            <label>IVA (%)</label>
                            <input type="number" formControlName="vatValue" min="0" class="form-control" />
                        </div>
                        <div class="col-6 mb-4">
                            <label>Tipo de IVA</label>
                            <select formControlName="vatType" class="form-control">
                                <option [value]="null">Sin IVA</option>
                                <option *ngFor="let vt of vatTypes" [value]="vt">{{ vt }}</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="row mb-2">
                    <h3>Presentaciones</h3>
                    <button type="button" class="btn btn-secondary mb-3 mt-2" (click)="addPresentation()">
                        <i class="bi bi-plus-circle"></i>
                        Agregar presentación
                    </button>
                </div>
                <div formArrayName="presentations" class="presentation-item"
                    style="max-height: 600px; min-height: 350px; overflow-y: auto; overflow-x: auto; padding: 6px;">
                    <div class="row g-4">
                        <div *ngFor="let pres of presentations.controls; let i = index" [formGroupName]="i"
                            class="col-12 col-md-6">
                            <div class="card shadow-sm mb-4" style="min-width: 320px; border-radius: 12px;">
                                <div class="card-body">
                                    <!-- ...dentro de la card-body de cada presentación... -->
                                    <div class="row">
                                        <!-- Primera fila: Barcode + botón -->
                                        <div class="col-12 mb-3 d-flex align-items-end">
                                            <div style="flex: 1;">
                                                <label>Barcode</label>
                                                <input formControlName="barcode" class="form-control" />
                                            </div>
                                            <button type="button" class="btn btn-outline-secondary ms-2 mb-2"
                                                (click)="generateBarcode(i)">
                                                <i class="bi bi-upc-scan"></i>
                                                Generar
                                            </button>
                                        </div>
                                        <!-- Segunda fila: Etiqueta -->
                                        <div class="col-12 mb-3">
                                            <label>Etiqueta</label>
                                            <input formControlName="label" class="form-control" />
                                        </div>
                                        <!-- Resto de los campos -->
                                        <div class="col-6 mb-3">
                                            <label>Precio venta</label>
                                            <input type="text" formControlName="salePrice" min="0"
                                                class="form-control text-rigth" appCurrencyFormat />
                                        </div>
                                        <div class="col-6 mb-3">
                                            <label>Precio costo</label>
                                            <input type="text" formControlName="costPrice" min="0"
                                                class="form-control" appCurrencyFormat />
                                        </div>
                                        <div class="col-6 mb-3">
                                            <label>Unidad medida</label>
                                            <select formControlName="unitMeasure" class="form-control">
                                                <option *ngFor="let um of unitMeasures" [value]="um">
                                                    {{ unitMeasureLabels[um] }}
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <label>Factor conversión</label>
                                            <input type="number" formControlName="conversionFactor" min="0.01"
                                                step="0.01" class="form-control" />
                                        </div>
                                        <div class="col-12 text-end">
                                            <button type="button" class="btn btn-danger btn-sm mt-2"
                                                (click)="removePresentation(i)">
                                                <i class="bi bi-trash"></i>
                                                Eliminar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>