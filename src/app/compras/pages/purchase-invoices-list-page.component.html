<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">Listado de Facturas de Compra</h4>
    <button type="button" class="btn btn-primary" (click)="goToCreateInvoice()">
      Nueva Factura
    </button>
  </div>

  <div class="card mb-3">
    <div class="card-header">
      <div class="d-flex justify-content-between align-items-center">
        <span>Filtros</span>
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="clearFilters()">
          Limpiar filtros
        </button>
      </div>
    </div>
    <div class="card-body">
      <form [formGroup]="filterForm">
        <div class="row g-3">
          <div class="col-12 col-md-3">
            <label class="form-label">Fecha inicio</label>
            <input type="date" class="form-control" formControlName="startDate">
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Fecha fin</label>
            <input type="date" class="form-control" formControlName="endDate">
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Proveedor</label>
            <div class="position-relative">
              <div class="input-group">
                <input 
                  type="text" 
                  class="form-control" 
                  [(ngModel)]="supplierFilterSearchText"
                  [ngModelOptions]="{standalone: true}"
                  (input)="filterSuppliersForFilter(supplierFilterSearchText)"
                  (focus)="showSupplierFilterDropdown = true"
                  placeholder="Buscar proveedor..."
                  autocomplete="off">
                <button 
                  type="button" 
                  class="btn btn-outline-danger" 
                  *ngIf="selectedSupplierForFilter"
                  (click)="clearSupplierFilterSelection()">
                  <i class="bi bi-x"></i>
                </button>
              </div>
              <div 
                *ngIf="showSupplierFilterDropdown && filteredSuppliersForFilter.length > 0" 
                class="position-absolute w-100 bg-white border rounded shadow-sm mt-1"
                style="max-height: 250px; overflow-y: auto; z-index: 1000;">
                <div 
                  *ngFor="let supplier of filteredSuppliersForFilter"
                  class="p-2 border-bottom cursor-pointer"
                  (click)="selectSupplierForFilter(supplier)"
                  style="cursor: pointer;"
                  (mouseenter)="$event.target.style.backgroundColor='#f8f9fa'"
                  (mouseleave)="$event.target.style.backgroundColor='white'">
                  <div class="fw-bold">{{ supplier.name }}</div>
                  <small class="text-muted">{{ supplier.documentType }} {{ supplier.idNumber }}</small>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Buscar producto</label>
            <div class="input-group">
              <input type="text" class="form-control" formControlName="productSearch" 
                     placeholder="Código o descripción" readonly>
              <button type="button" class="btn btn-outline-secondary" (click)="openProductModal()">
                Buscar
              </button>
              <button type="button" class="btn btn-outline-danger" *ngIf="selectedProduct" (click)="clearProductFilter()">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Facturas ({{ getTotalInvoices() }})</span>
      <span class="badge bg-primary">Total: {{ formatCurrency(getTotalAmount()) }}</span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle m-0">
          <thead class="table-light">
            <tr>
              <th style="width: 50px;"></th>
              <th>Fecha ingreso</th>
              <th>Fecha factura</th>
              <th>Nº Factura</th>
              <th>Proveedor</th>
              <th>Tipo pago</th>
              <th class="text-end">Total</th>
              <th class="text-center">Ítems</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let invoice of filteredInvoices">
              <tr (click)="toggleInvoiceDetails(invoice.id)" style="cursor: pointer;">
                <td class="text-center">
                  <i [class]="isExpanded(invoice.id) ? 'bi bi-chevron-down' : 'bi bi-chevron-right'"></i>
                </td>
                <td>{{ formatDate(invoice.createdAt) || '-' }}</td>
                <td>{{ formatDate(invoice.emissionDate) || '-' }}</td>
                <td>{{ invoice.invoiceNumber || '-' }}</td>
                <td>{{ getSupplierName(invoice) }}</td>
                <td>
                  <span *ngIf="invoice.paymentType" [class]="invoice.paymentType === 'CONTADO' ? 'badge bg-success' : 'badge bg-warning'">
                    {{ invoice.paymentType }}
                  </span>
                  <span *ngIf="!invoice.paymentType" class="text-muted">-</span>
                </td>
                <td class="text-end fw-bold">{{ formatCurrency(invoice.total) }}</td>
                <td class="text-center">{{ invoice.items?.length || 0 }}</td>
                <td class="text-center">
                  <button type="button" class="btn btn-sm btn-outline-primary" 
                          (click)="editInvoice(invoice.id); $event.stopPropagation()"
                          title="Agregar productos a esta factura">
                    <i class="bi bi-plus-circle me-1"></i>Agregar
                  </button>
                </td>
              </tr>
              <tr *ngIf="isExpanded(invoice.id)">
                <td colspan="9" class="bg-light">
                  <div class="p-3">
                    <h6 class="mb-3">Detalle de ítems</h6>
                    <div class="table-responsive">
                      <table class="table table-sm table-bordered m-0">
                        <thead>
                          <tr>
                            <th>Producto</th>
                            <th>Código barras</th>
                            <th class="text-end">Cantidad</th>
                            <th class="text-end">Costo unit.</th>
                            <th class="text-end">Total</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let item of invoice.items">
                            <td>{{ item.description }}</td>
                            <td>{{ item.presentationBarcode || item.presentationId }}</td>
                            <td class="text-end">{{ item.quantity }}</td>
                            <td class="text-end">{{ formatCurrency(item.unitCost) }}</td>
                            <td class="text-end">{{ formatCurrency(item.totalCost) }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <div class="mt-2" *ngIf="invoice.notes">
                      <strong>Notas:</strong> {{ invoice.notes }}
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>
            <tr *ngIf="filteredInvoices.length === 0">
              <td colspan="9" class="text-center text-muted py-4">
                No se encontraron facturas con los filtros aplicados
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<app-products-search-modal (selectPresentation)="onProductSelected($event)"></app-products-search-modal>
