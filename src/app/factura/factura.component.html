<!-- Secciones reorganizadas en columnas: Factura, Cliente, Totales y Productos -->
<div class="container-fluid">
  <h2 class="text-primary text-center">Factura de Venta</h2>
  <!-- Acciones -->
  <div class="row mt-3">
    <div class="col text-start">
      <div class="dropdown">
        <button class="btn btn-primary dropdown-toggle" type="button" id="accionesDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-gear-fill me-1"></i> Acciones Factura
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="accionesDropdown">
          <li>
            <button class="dropdown-item" (click)="onInitBilling()">
              <i class="bi bi-file-earmark-plus me-1"></i> Nueva Factura (F2)
            </button>
          </li>
          <li>
            <button class="dropdown-item" (click)="saveBilling()">
              <i class="bi bi-save me-1"></i> Guardar Factura (F4)
            </button>
          </li>
          <li>
            <button class="dropdown-item" (click)="printTicketBilling()">
              <i class="bi bi-printer me-1"></i> Imprimir Factura
            </button>
          </li>
          <li>
            <button class="dropdown-item" (click)="openProductsModal()">
              <i class="bi bi-search me-1"></i> Buscar productos (F3)
            </button>
          </li>
        </ul>
          </div>
  </div>
  </div>

  <hr class="my-3">
  <!-- Cabecera: Cliente, Totales, Productos Vendidos -->
  <div class="container-fluid px-3 pt-2 pb-3">
  <div class="row mb-2">
    <!-- Cliente y Factura -->
    <div class="col-md-3">
  <div class="border border-info rounded p-2 shadow-sm bg-white fs-6">
    <h6 class="text-info mb-2">
      <i class="bi bi-receipt-cutoff me-1"></i> Factura
    </h6>
    <div class="mb-1">
      <strong>No:</strong>
      <span class="float-end text-muted">{{ factura?.billNumber }}</span>
    </div>
    <div class="mb-2">
      <strong>Fecha:</strong>
      <span class="float-end text-muted">{{ factura?.dateTimeRecord | date:'dd-MM-yyyy' }}</span>
    </div>

    <h6 class="text-primary mb-2">
      <i class="bi bi-person-vcard me-1"></i> Cliente
    </h6>
    <div class="mb-2">
      <span class="badge" [ngClass]="paymentType === 'CREDITO' ? 'bg-warning text-dark' : 'bg-success'">
        {{ paymentType === 'CREDITO' ? 'Venta a CRÉDITO' : 'Venta de CONTADO' }}
      </span>
    </div>
    <div class="mb-2">
      <button type="button" class="btn btn-outline-primary btn-sm w-100" (click)="openClientsModal()">
        <i class="bi bi-people me-1"></i> Buscar cliente
      </button>
    </div>
    <div class="mb-1">
      <strong>Doc:</strong>
      <span class="float-end">{{ client?.documentType }} {{ client?.idNumber }}</span>
    </div>
    <div class="mb-1">
      <strong>Nombre:</strong>
      <span class="float-end">
        @if (client?.name) {
          {{client?.name}} {{client?.surname}}
        } @else if (client?.businessName) {
          {{client?.businessName}}
        }
      </span>
    </div>
    <div class="mb-1">
      <strong>Dir:</strong>
      <span class="float-end">{{ client?.address }}</span>
    </div>
    <div class="mb-1">
      <strong>Tel:</strong>
      <span class="float-end">{{ client?.phone }}</span>
    </div>
    <div class="mb-2">
      <strong>Email:</strong>
      <span class="float-end">{{ client?.email }}</span>
    </div>
    @if (paymentType === 'CREDITO') {
      <div class="alert alert-warning p-1 mb-2" role="alert">
        Para ventas a CRÉDITO debe seleccionar un cliente distinto a "Consumidor Final".
      </div>
    }
  </div>
  </div>


    <!-- Totales -->
    <div class="col-md-3">
      <div class="border border-2 border-primary rounded p-3 shadow-sm bg-light">
        <h5 class="text-primary mb-3">
          <i class="bi bi-calculator me-1"></i> Totales
        </h5>
        <div class="mb-3">
          <div class="text-dark fw-bold fs-5">
            <i class="bi bi-cash-stack me-1 text-success"></i>
            Total a Pagar:
            <span class="text-success float-end">{{ calculateTotalBilling() | currency:'$ ':'symbol':'.0-0' }}</span>
          </div>
        </div>
        <div class="mb-2">
          <label for="paymentType" class="form-label fw-bold text-primary">
            <i class="bi bi-ui-radios me-1"></i> Tipo de Venta:
          </label>
          <select id="paymentType" class="form-select form-select-sm" [value]="paymentType" (change)="setPaymentType($event.target.value === 'CREDITO' ? 'CREDITO' : 'CONTADO')">
            <option value="CONTADO">CONTADO</option>
            <option value="CREDITO">CRÉDITO</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label fw-bold text-primary">
            <i class="bi bi-cash-coin me-1"></i> EFECTIVO (rápido F8):
          </label>
          <input #reciveValueInput id="reciveValue" [formControl]="reciveValue" type="text" class="form-control form-control-sm border-primary text-end fw-bold"
                 appCurrencyFormat [disabled]="paymentType === 'CREDITO'">
        </div>
        <div class="mb-2">
          <label class="form-label fw-bold text-primary">
            <i class="bi bi-credit-card me-1"></i> Pagos:
          </label>
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Método</th>
                  <th class="text-end">Monto</th>
                  <th>Referencia</th>
                  <th class="text-center" style="width: 40px;"></th>
                </tr>
              </thead>
              <tbody>
                @for (group of paymentControls; let i = $index; track i) {
                <tr [formGroup]="group">
                  <td>
                    <select class="form-select form-select-sm" formControlName="method" [disabled]="paymentType === 'CREDITO'">
                      <option value="EFECTIVO">EFECTIVO</option>
                      <option value="TRANSFERENCIA">TRANSFERENCIA</option>
                      <option value="TARJETA_CREDITO">TARJETA CREDITO</option>
                      <option value="TARJETA_DEBITO">TARJETA DEBITO</option>
                      <option value="CHEQUE">CHEQUE</option>
                    </select>
                  </td>
                  <td>
                    <input type="text" class="form-control form-control-sm text-end" formControlName="amount" appCurrencyFormat [disabled]="paymentType === 'CREDITO'">
                  </td>
                  <td>
                    <input type="text" class="form-control form-control-sm" placeholder="Ref/Nota" formControlName="reference" [disabled]="paymentType === 'CREDITO'">
                  </td>
                  <td class="text-center">
                    <button type="button" class="btn btn-outline-danger btn-sm" (click)="removePaymentRow(i)" [disabled]="paymentType === 'CREDITO' || paymentControls.length === 1">
                      <i class="bi bi-x"></i>
                    </button>
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>
          <div class="d-grid">
            <button type="button" class="btn btn-outline-primary btn-sm" (click)="addPaymentRow()" [disabled]="paymentType === 'CREDITO'">
              <i class="bi bi-plus-circle me-1"></i> Agregar pago
            </button>
          </div>
        </div>
        <div class="mb-2 text-muted">
          <strong>Vueltas:</strong>
          <span class="float-end">{{ totalMoneyChange | currency:'$ ':'symbol':'.0-0' }}</span>
        </div>
        <div class="text-muted">
          <strong>Productos agregados:</strong>
          <span class="float-end">{{ saleDetails.length }}</span>
        </div>
      </div>
    </div>

    <!-- Productos Vendidos -->
    <div class="col-md-6">
      <h5 class="text-primary">Productos Vendidos</h5>
      <div class="table-responsive fs-6" style="max-height: 60vh; overflow-y: auto;">
        <table class="table table-sm table-bordered align-middle text-center">
          <thead class="table-primary sticky-top">
            <tr>
              <th class="text-nowrap">#</th>
              <th class="text-nowrap">Código</th>
              <th class="text-start">Descripción</th>
              <th class="text-nowrap">Cantidad vendida</th>
              <th class="text-nowrap">Precio de venta</th>
              <th class="text-nowrap">Total vendido</th>
              <th class="text-nowrap"></th>
            </tr>
          </thead>
          <tbody class="bg-white">
            @if (saleDetails.length) {
              @for (saleDetail of saleDetails; track $index) {
              <tr>
                <td class="text-nowrap">{{$index + 1}}</td>
                <td class="text-nowrap">{{saleDetail.product.barcode}}</td>
                <td class="text-start">
                  {{saleDetail.product.description}}
                </td>
                <td>
                  <div class="btn-group">
                    <button class="btn btn-danger btn-sm" (click)="restarCantidad($index, saleDetail.amount)">-</button>
                    <input type="number" class="form-control form-control-sm text-center"
                          style="width: 60px;"
                          [value]="saleDetail.amount"
                          (input)="onCantidadChange($event, $index)">
                    <button class="btn btn-success btn-sm" (click)="sumarCantidad($index)">+</button>
                  </div>
                </td>
                <td>
                  <input type="text"
                        class="form-control form-control-sm text-center"
                        value="{{saleDetail.unitPrice | currency:'$ ':'symbol':'.0-0'}}"
                        (input)="onUnitValueChange($event, $index)"
                        appCurrencyFormat>
                </td>
                <td>{{saleDetail.subTotal | currency:'$ ':'symbol':'.0-0'}}</td>
                <td>
                  <button type="button" class="btn btn-danger btn-sm" (click)="deleteProductOfList($index)">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
              }
            }
          </tbody>
        </table>
      </div>

    </div>
  </div>
    </div>
  </div>

  


  <!-- Modal de productos (componente unificado) -->
  <app-products-search-modal (selectPresentation)="onPresentationSelected($event)"></app-products-search-modal>

<!-- Modal cantidad -->
<div class="modal fade" id="productsAmountModal" #productsAmountModal tabindex="-1" aria-labelledby="productsAmountModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cantidad a Vender de {{productToSell.description}}</h5>
        <button type="button" class="btn-close" (click)="closeProductAmountModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="formProductAmount" (ngSubmit)="addAmountProduct()" class="d-flex flex-column gap-2 mb-3" autocomplete="off">
          <div class="input-group">
            <!-- Modo granel: ingresar Total $ con formato moneda -->
            <input *ngIf="productToSell?.isBulk && (productToSell?.saleType === 'WEIGHT' || productToSell?.saleType === 'VOLUME' || productToSell?.saleType === 'LONGITUDE')"
                   class="form-control" type="text"
                   placeholder="Ingresar Total $ vendido"
                   formControlName="amountProduct" #amountProductInput
                   appCurrencyFormat
                   (formattedValue)="onBulkTotalInput($event)"
                   (input)="onBulkTotalInput($event.target.value)">
            <!-- Modo normal o fijo: ingresar cantidad -->
            <input *ngIf="!(productToSell?.isBulk && (productToSell?.saleType === 'WEIGHT' || productToSell?.saleType === 'VOLUME' || productToSell?.saleType === 'LONGITUDE')) || productToSell?.hasFixedAmount"
                   class="form-control" type="text"
                   placeholder="Ingresar la Cantidad"
                   formControlName="amountProduct" #amountProductInput>
            <button class="btn btn-primary" type="submit">
              <i class="bi bi-check-circle me-1"></i> Aceptar
            </button>
            <button class="btn btn-info" type="button" (click)="clearProductAmountField()"><i class="bi bi-eraser me-1"></i> Limpiar</button>
          </div>
          <div *ngIf="productToSell?.isBulk && (productToSell?.saleType === 'WEIGHT' || productToSell?.saleType === 'VOLUME' || productToSell?.saleType === 'LONGITUDE')" class="form-text">
            Modo granel: ingrese el <strong>total $ vendido</strong>. La cantidad será calculada como <em>total / precio unitario</em>.
            Precio unitario: <strong>{{ productToSell?.price | currency:'$ ':'symbol':'.0-0' }}</strong>.
          </div>
          <div *ngIf="productToSell?.isBulk && (productToSell?.saleType === 'WEIGHT' || productToSell?.saleType === 'VOLUME' || productToSell?.saleType === 'LONGITUDE')" class="mt-2">
            <div class="card border-success text-center">
              <div class="card-body">
                <div class="text-muted">Cantidad calculada</div>
                <div class="display-4 fw-bold text-success">
                  {{ bulkComputedAmount | number:'1.1-1' }}
                  <span class="fs-4 text-secondary">{{ productToSell?.saleType === 'VOLUME' ? 'MILILITROS' : (productToSell?.selectedUnitMeasure || productToSell?.stock?.unitMeasure) }}</span>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-info" (click)="returnToProductsModal()">
          <i class="bi bi-arrow-left-circle me-1"></i>Volver al listado de productos
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Clientes modal handled by reusable component -->
<app-modal-clients-list (clientSelected)="selectClient($event)"></app-modal-clients-list>

<!-- Floating Expenses FAB (reusable) -->
<app-expenses-fab [source]="'factura'"></app-expenses-fab>

<!-- Confirm Save Billing Modal -->
<div class="modal fade" id="confirmSaveModal" #confirmSaveModal tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar guardado</h5>
        <button type="button" class="btn-close" (click)="cancelSaveBilling()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>¿Desea guardar la factura?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelSaveBilling()" title="N / Esc">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="confirmSaveBilling()" title="Y / Enter">Confirmar</button>
      </div>
    </div>
  </div>
</div>
