<div class="container mb-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">Listado de Facturas de Venta</h4>
  </div>

  <!-- FILTERS -->
  <div class="card mb-3">
    <div class="card-header">
      <div class="d-flex justify-content-between align-items-center">
        <span>Filtros</span>
        <button type="button" class="btn btn-sm btn-outline-secondary" (click)="clearFilters()">
          Limpiar filtros
        </button>
      </div>
    </div>
    <div class="card-body">
      <form [formGroup]="filterForm">

        <div class="row g-3">
          <!-- FECHA DESDE -->
          <div class="col-12 col-md-3">
            <label class="form-label">Fecha desde</label>
            <input type="date" class="form-control" formControlName="startDate" [max]="today"/>
          </div>
          
          <!-- FECHA HASTA -->
          <div class="col-12 col-md-3">
            <label class="form-label">Fecha hasta</label>
            <input type="date" class="form-control" formControlName="endDate" [max]="today"/>
          </div>

          <!-- CLIENTE -->
          <div class="col-12 col-md-3">
            <label class="form-label">Cliente</label>
            <div class="position-relative">
              <div class="input-group">
                <input 
                  type="text" 
                  class="form-control" 
                  [(ngModel)]="clientSearchText"
                  [ngModelOptions]="{standalone: true}"
                  (input)="filterClients(clientSearchText)"
                  (focus)="showClientDropdown = true"
                  placeholder="Buscar cliente..."
                  autocomplete="off">
                <button 
                  type="button" 
                  class="btn btn-outline-danger" 
                  *ngIf="selectedClient"
                  (click)="clearClientSelection()">
                  <i class="bi bi-x"></i>
                </button>
              </div>
              <div 
                *ngIf="showClientDropdown && filteredClientsForFilter.length > 0" 
                class="position-absolute w-100 bg-white border rounded shadow-sm mt-1"
                style="max-height: 250px; overflow-y: auto; z-index: 1000;">
                <div 
                  *ngFor="let client of filteredClientsForFilter"
                  class="p-2 border-bottom cursor-pointer"
                  (click)="selectClientForFilter(client)"
                  style="cursor: pointer;"
                  (mouseenter)="$event.target.style.backgroundColor='#f8f9fa'"
                  (mouseleave)="$event.target.style.backgroundColor='white'">
                  <div class="fw-bold">{{ getClientDisplayName(client) }}</div>
                  <small class="text-muted">{{ client.documentType }} {{ client.idNumber }}</small>
                </div>
              </div>
            </div>
          </div>
          <!-- PRODUCTO -->
          <div class="col-12 col-md-3">
            <label class="form-label">Buscar producto</label>
            <div class="input-group">
              <input type="text" class="form-control" formControlName="productSearch" 
                     placeholder="Código o descripción" readonly>
              <button type="button" class="btn btn-outline-secondary" (click)="openProductModal()">
                Buscar
              </button>
              <button type="button" class="btn btn-outline-danger" *ngIf="selectedProduct" (click)="clearProductFilter()">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>
        </div>
        
        <div class="row g-3 mt-2">
          <!-- TIPO DE VENTA -->
          <div class="col-12 col-md-3">
            <label class="form-label">Tipo de venta</label>
            <select class="form-select" formControlName="saleType">
              <option value="">Todos</option>
              <option value="CONTADO">Contado</option>
              <option value="CREDITO">Crédito</option>
            </select>
          </div>
          
          <!-- NÚMERO DE FACTURA -->
          <div class="col-12 col-md-3">
            <label class="form-label">Número de factura</label>
            <input type="text" class="form-control" formControlName="billNumber" placeholder="Ej: FAC-001">
          </div>
        </div>
        
        <!-- BOTONES -->
        <div class="row g-3 mt-2">
          <div class="col-12">
            <button class="btn btn-primary" type="button" (click)="applyFilters()">
              <i class="bi bi-funnel"></i> Aplicar filtros
            </button>
            <button class="btn btn-outline-secondary ms-2" type="button" (click)="clearFilters()">
              <i class="bi bi-x-circle"></i> Limpiar
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>


  <!-- INVOICES TABLE -->

  <div class="w-100 overflow-auto mb-4 mt-4" >
    <table class="table text-center table-striped table-wrapper" style="vertical-align: middle;">
      <thead>
        <tr class="table-primary">
          <th scope="col">No. Factura</th>
          <th scope="col">Fecha emisión</th>
          <th scope="col">Cliente</th>
          <th scope="col">Total venta</th>
          <th scope="col">Total IVA</th>
          <th scope="col">Tipo de venta</th>
          <th scope="col">Medio de pago</th>
          <th scope="col">Vendedor</th>
          <th scope="col"></th>
        </tr>
      </thead>
      <tbody>
        @if (!isLoading) {
          @for (billing of filteredBilling; track $index) {
            <tr class="table table-hover align-middle" style="cursor: pointer;" (click)="toggleBillingDetails(billing.id)">
              <td style="text-align: center;">
                <i class="bi" [ngClass]="expandedBillingId === billing.id ? 'bi-chevron-down' : 'bi-chevron-right'"></i>
                <span class="ms-2">{{billing.billNumber}}</span>
              </td>

              <td style="text-align: center;">
                <span>{{formatDate(billing.dateTimeRecord)}}</span>
              </td>

              <td style="text-align: center;">
                <span>{{billing.client.fullName}}</span>
              </td>

              <td style="text-align: center;">
                <span>{{billing.subTotalSale | currency:'$ ':'symbol':'.0-0'}}</span>
              </td>

              <td style="text-align: center;">
                <span>{{billing.totalIVAT | currency:'$ ':'symbol':'.0-0'}}</span>
              </td>

              <td style="text-align: center;">
                @if (billing.saleType === 'CONTADO') {
                  <span class="badge bg-success">Contado</span>
                } @else if (billing.saleType === 'CREDITO') {
                  <span class="badge bg-warning text-dark">Crédito</span>
                } @else {
                  <span class="badge bg-secondary">N/A</span>
                }
              </td>

              <td style="text-align: center;">
                @if (billing.payments && billing.payments.length > 0) {
                  <div class="d-flex flex-column align-items-center gap-1">
                    @for (payment of billing.payments; track $index) {
                      @if (payment.amount > 0) {
                        <span class="badge" [ngClass]="getPaymentBadgeClass(payment.method)">
                          <i class="bi me-1" [ngClass]="getPaymentIcon(payment.method)"></i>
                          {{ formatPaymentMethod(payment.method) }}: {{ payment.amount | currency:'$ ':'symbol':'.0-0' }}
                          @if (payment.reference) {
                            <small class="ms-1">({{ payment.reference }})</small>
                          }
                        </span>
                      }
                    }
                  </div>
                } @else if (billing.paymentMethods && billing.paymentMethods.length > 0) {
                  <span class="badge bg-secondary">{{ billing.paymentMethods[0] }}</span>
                } @else {
                  <span class="badge bg-light text-dark">N/A</span>
                }
              </td>

              @if (billing.order && billing.order.orderNumber > 0) {
                <td style="text-align: center;">
                  <span>{{billing.order.creationUser?.fullName}}</span>
                </td>
              } @else {
                <td style="text-align: center;">
                  <span>{{billing.creationUser?.fullName}}</span>
                </td>
              }
              <td style="text-align: center;" (click)="$event.stopPropagation()">
                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Acciones</button>
                <div class="dropdown-menu" style="background-color: white; border-color: black;">
                  <button class="dropdown-item" (click)="openSaleDetailModal(billing)">Ver detalle</button>
                  <button class="dropdown-item" (click)="printTicketBilling(billing)">Imprimir factura</button>
                  <button class="dropdown-item">Enviar a la DIAN</button>
                </div>
              </td>
            </tr>
            
            <!-- DETALLE EXPANDIBLE DE PRODUCTOS -->
            @if (expandedBillingId === billing.id) {
              <tr>
                <td colspan="9" class="p-0">
                  <div class="p-3" style="background-color: #f8f9fa;">
                    <!-- Información de pagos -->
                    @if (billing.payments && billing.payments.length > 0) {
                      <div class="mb-3 p-2 bg-white rounded border">
                        <h6 class="mb-2"><i class="bi bi-wallet2 me-1"></i> Detalle de Pagos</h6>
                        <div class="row g-2">
                          @for (payment of billing.payments; track $index) {
                            @if (payment.amount > 0) {
                              <div class="col-auto">
                                <div class="d-flex align-items-center p-2 border rounded" [ngClass]="getPaymentBorderClass(payment.method)">
                                  <i class="bi fs-5 me-2" [ngClass]="getPaymentIcon(payment.method)"></i>
                                  <div>
                                    <div class="fw-bold">{{ formatPaymentMethod(payment.method) }}</div>
                                    <div class="text-success fw-bold">{{ payment.amount | currency:'$ ':'symbol':'.0-0' }}</div>
                                    @if (payment.reference) {
                                      <small class="text-muted">Ref: {{ payment.reference }}</small>
                                    }
                                  </div>
                                </div>
                              </div>
                            }
                          }
                          <div class="col-auto">
                            <div class="d-flex align-items-center p-2 border rounded border-dark bg-light">
                              <div>
                                <div class="fw-bold">Total Recibido</div>
                                <div class="text-primary fw-bold fs-5">{{ billing.receivedValue | currency:'$ ':'symbol':'.0-0' }}</div>
                                @if (billing.returnedValue > 0) {
                                  <small class="text-warning">Vueltas: {{ billing.returnedValue | currency:'$ ':'symbol':'.0-0' }}</small>
                                }
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    }
                    <h6 class="mb-3"><i class="bi bi-box-seam"></i> Productos vendidos</h6>
                    <div class="table-responsive">
                      <table class="table table-sm table-bordered mb-0">
                        <thead style="background-color: #e9ecef;">
                          <tr>
                            <th>Producto</th>
                            <th>Código de barras</th>
                            <th class="text-center">Cantidad</th>
                            <th class="text-end">Precio unitario</th>
                            <th class="text-end">Subtotal</th>
                            <th class="text-end">IVA</th>
                            <th class="text-end">Total</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (detail of billing.saleDetails; track detail.id) {
                            <tr>
                              <td>{{ detail.product?.description || 'N/A' }}</td>
                              <td>{{ detail.product?.barcode || 'N/A' }}</td>
                              <td class="text-center">{{ detail.amount || 0 }}</td>
                              <td class="text-end">{{ (detail.unitPrice || 0) | currency:'$ ':'symbol':'.0-0' }}</td>
                              <td class="text-end">{{ (detail.subTotal || 0) | currency:'$ ':'symbol':'.0-0' }}</td>
                              <td class="text-end">{{ (detail.totalVat || 0) | currency:'$ ':'symbol':'.0-0' }}</td>
                              <td class="text-end fw-bold">{{ ((detail.subTotal || 0) + (detail.totalVat || 0)) | currency:'$ ':'symbol':'.0-0' }}</td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  </div>
                </td>
              </tr>
            }
          }
        }
      </tbody>
    </table>
  </div>
  @if (!isLoading) {
    <!-- TOTALS SECTION -->
    <div class="container mt-4 ">

      <div class="row g-3 justify-content-center">
        <div class="col-md-2">
          <div class="card text-white bg-primary">
            <div class="card-header">Facturas:</div>
            <div class="card-body">
              <p class="card-text fw-bold">{{filteredBilling.length}}</p>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card text-white bg-primary">
            <div class="card-header">Total Ventas:</div>
            <div class="card-body">
              <p class="card-text fw-bold">{{subTotal() | currency:'$ ':'symbol':'.0-0'}}</p>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card text-white bg-primary">
            <div class="card-header">Total Iva:</div>
            <div class="card-body">
              <p class="card-text fw-bold">{{totalIvat() | currency:'$ ':'symbol':'.0-0'}}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  }
  <app-modal-sale-detail
    [saleDetails]="selectedBilling?.saleDetails"
    [billingNumber]="selectedBilling?.billNumber">
  </app-modal-sale-detail>

  @if (isLoading) {
    <!-- LOADING OVERLAY -->
    <div class="fullscreen-loading bg-light bg-opacity-75">
      <div class="text-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <div class="mt-3 fw-semibold">Cargando datos {{ userLogin?.fullName }}, por favor espera...</div>
      </div>
    </div>
  }
</div>

<app-products-search-modal (selectPresentation)="onProductSelected($event)"></app-products-search-modal>
