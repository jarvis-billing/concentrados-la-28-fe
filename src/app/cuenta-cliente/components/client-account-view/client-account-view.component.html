<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="mb-0">
                <i class="bi bi-person-lines-fill me-2"></i>
                Estado de Cuenta del Cliente
            </h4>
        </div>
    </div>

    <!-- Buscador de cliente -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <label class="form-label fw-bold">Seleccionar Cliente</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input 
                            type="text" 
                            class="form-control" 
                            placeholder="Buscar por nombre, documento o razón social..."
                            [value]="clientSearchText"
                            (input)="filterClients($any($event.target).value)"
                            (focus)="showClientDropdown = filteredClients.length > 0"
                        >
                        @if (selectedClient) {
                            <button class="btn btn-outline-secondary" type="button" (click)="clearClientSelection()">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        }
                    </div>
                    
                    @if (showClientDropdown && !selectedClient) {
                        <div class="dropdown-menu show w-100 mt-1" style="max-height: 250px; overflow-y: auto;">
                            @for (client of filteredClients; track client.id) {
                                <button class="dropdown-item" (click)="selectClient(client)">
                                    <strong>{{ getClientDisplayName(client) }}</strong>
                                    <br>
                                    <small class="text-muted">{{ client.idNumber }}</small>
                                </button>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (selectedClient) {
        <!-- Resumen del cliente -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card shadow-sm border-danger">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Deuda Pendiente</h6>
                        <h3 class="text-danger mb-0">
                            {{ (clientAccount?.currentBalance || 0) | currency:'COP':'symbol-narrow':'1.0-0' }}
                        </h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm border-success">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Saldo a Favor</h6>
                        <h3 class="text-success mb-0">
                            {{ (clientCredit?.currentBalance || 0) | currency:'COP':'symbol-narrow':'1.0-0' }}
                        </h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-2">Último Pago</h6>
                        <h5 class="mb-0">
                            {{ clientAccount?.lastPaymentDate ? formatDate(clientAccount.lastPaymentDate) : 'Sin pagos' }}
                        </h5>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acciones rápidas -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex gap-2">
                    <button 
                        class="btn btn-primary"
                        data-bs-toggle="modal" 
                        data-bs-target="#paymentRegisterModal"
                        [disabled]="!clientAccount || clientAccount.currentBalance <= 0"
                    >
                        <i class="bi bi-cash-coin me-2"></i>
                        Registrar Pago a Cuenta
                    </button>
                    <button 
                        class="btn btn-success"
                        data-bs-toggle="modal" 
                        data-bs-target="#creditRegisterModal"
                    >
                        <i class="bi bi-plus-circle me-2"></i>
                        Registrar Anticipo
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-tabs mb-3">
                    <li class="nav-item">
                        <button 
                            class="nav-link" 
                            [class.active]="activeTab === 'debt'"
                            (click)="setActiveTab('debt')"
                        >
                            <i class="bi bi-credit-card me-2"></i>
                            Cuenta por Cobrar
                        </button>
                    </li>
                    <li class="nav-item">
                        <button 
                            class="nav-link" 
                            [class.active]="activeTab === 'credit'"
                            (click)="setActiveTab('credit')"
                        >
                            <i class="bi bi-wallet2 me-2"></i>
                            Saldo a Favor / Anticipos
                        </button>
                    </li>
                </ul>

                @if (isLoading) {
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                } @else {
                    <!-- Tab: Cuenta por Cobrar -->
                    @if (activeTab === 'debt') {
                        <div class="card shadow-sm">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Historial de Pagos a Cuenta</h6>
                            </div>
                            <div class="card-body p-0">
                                @if (paymentHistory.length === 0) {
                                    <div class="text-center py-4 text-muted">
                                        <i class="bi bi-inbox fs-1"></i>
                                        <p class="mt-2">No hay pagos registrados</p>
                                    </div>
                                } @else {
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Fecha</th>
                                                    <th>Monto</th>
                                                    <th>Método</th>
                                                    <th>Referencia</th>
                                                    <th>Notas</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (payment of paymentHistory; track payment.id) {
                                                    <tr>
                                                        <td>{{ formatDate(payment.paymentDate) }}</td>
                                                        <td class="text-success fw-bold">
                                                            {{ payment.amount | currency:'COP':'symbol-narrow':'1.0-0' }}
                                                        </td>
                                                        <td>{{ payment.paymentMethod }}</td>
                                                        <td>{{ payment.reference || '-' }}</td>
                                                        <td>{{ payment.notes || '-' }}</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Facturas a crédito pendientes -->
                        @if (clientAccount?.creditBillings && clientAccount.creditBillings.length > 0) {
                            <div class="card shadow-sm mt-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Facturas a Crédito</h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>No. Factura</th>
                                                    <th>Fecha</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (billing of clientAccount.creditBillings; track billing.id) {
                                                    <tr>
                                                        <td>{{ billing.billNumber }}</td>
                                                        <td>{{ formatDate(billing.dateTimeRecord) }}</td>
                                                        <td class="fw-bold">
                                                            {{ billing.totalBilling | currency:'COP':'symbol-narrow':'1.0-0' }}
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        }
                    }

                    <!-- Tab: Saldo a Favor -->
                    @if (activeTab === 'credit') {
                        <div class="card shadow-sm">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Historial de Transacciones</h6>
                            </div>
                            <div class="card-body p-0">
                                @if (creditTransactions.length === 0) {
                                    <div class="text-center py-4 text-muted">
                                        <i class="bi bi-inbox fs-1"></i>
                                        <p class="mt-2">No hay transacciones registradas</p>
                                    </div>
                                } @else {
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Fecha</th>
                                                    <th>Tipo</th>
                                                    <th>Monto</th>
                                                    <th>Saldo Después</th>
                                                    <th>Referencia</th>
                                                    <th>Notas</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @for (tx of creditTransactions; track tx.id) {
                                                    <tr>
                                                        <td>{{ formatDate(tx.transactionDate) }}</td>
                                                        <td>
                                                            <span [class]="getTransactionTypeClass(tx.type)">
                                                                {{ getTransactionTypeLabel(tx.type) }}
                                                            </span>
                                                        </td>
                                                        <td [class]="tx.type === 'DEPOSIT' ? 'text-success' : 'text-warning'">
                                                            {{ tx.type === 'DEPOSIT' ? '+' : '-' }}{{ tx.amount | currency:'COP':'symbol-narrow':'1.0-0' }}
                                                        </td>
                                                        <td>{{ tx.balanceAfter | currency:'COP':'symbol-narrow':'1.0-0' }}</td>
                                                        <td>{{ tx.reference || '-' }}</td>
                                                        <td>{{ tx.notes || '-' }}</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    } @else {
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5 text-muted">
                        <i class="bi bi-person-badge fs-1"></i>
                        <p class="mt-3">Seleccione un cliente para ver su estado de cuenta</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Modal Registrar Pago -->
<app-payment-register-modal
    [client]="selectedClient"
    [maxAmount]="clientAccount?.currentBalance || 0"
    (paymentRegistered)="onPaymentRegistered()"
></app-payment-register-modal>

<!-- Modal Registrar Anticipo -->
<app-credit-register-modal
    [client]="selectedClient"
    (creditRegistered)="onCreditRegistered()"
></app-credit-register-modal>
